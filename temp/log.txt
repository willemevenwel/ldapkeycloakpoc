âœ… Services started successfully
â³ Waiting for services to fully initialize...
Checking service readiness...
âœ“ ldap container is running
âœ“ keycloak container is running
âœ“ python-bastion container is running
â³ Allowing startup time for services to initialize...
This ensures compatibility across macOS, Windows, and slower systems
Startup check 1/6...
âœ“ LDAP service is responding
ğŸ”„ Step 1.5: Generating LDIF files and loading initial data...
ğŸ“ Generating LDIF from CSV files using containerized Python...
Known admin users: admin
Auto-detected mode: 'admins' (filename suggests admin users)
Using CSV file: data/admins.csv
Output files: /opt/output/admins_only.ldif, /opt/output/users.ldif, /opt/output/group_assign.ldif
Admin users identified: admin
Admins processed: ['admin']
Users processed: []
LDIF files generated: /opt/output/admins_only.ldif, /opt/output/users.ldif, /opt/output/group_assign.ldif
âœ“ LDIF generation completed
ğŸ” Validating generated LDIF files...
âœ“ admins_only.ldif exists with 1 users and 1 groups
ğŸ“¥ Loading admin users into LDAP...
Setting up LDAP initial data...
Waiting for LDAP server to be ready...
LDAP container is running, checking LDAP service availability...
LDAP server is ready!
Importing LDIF data...
Copying and importing admin users...
Successfully copied 2.05kB to ldap:/tmp/admins_only.ldif
Importing admin LDIF...
C:/Users/wevenwel/AppData/Local/Temp/admins_only.ldif: No such file or directory
âš ï¸  LDIF import had warnings (possibly duplicate entries)
Validating admin user creation...
âœ“ Admin user 'admin' found in LDAP
Validating admin group creation...
âœ“ Admin group 'admins' found in LDAP
âœ… Admin import completed and validated successfully!
LDAP initial data setup completed!
âœ… Initial LDAP data loaded and validated successfully

ğŸ”„ Step 2: Creating Keycloak realm 'acme'...
ğŸ—ï¸  Creating  Keycloak Realm: acme
ğŸš€ Starting realm creation process...
â³ Waiting for Keycloak to be ready...
.........âœ… Keycloak is ready!
ğŸ”‘ Getting master admin token...
âœ… Got master admin token
ğŸ” Checking if realm 'acme' already exists...
ğŸ—ï¸  Creating realm 'acme'...
âœ… Created realm 'acme'
ğŸ‘¤ Creating realm admin user 'admin-acme'...
âœ… Created user 'admin-acme'
ğŸ” Getting user ID for 'admin-acme'...
âœ… Got user ID: b76cf0fe-fc1e-4685-ab68-9e83135ae977
ğŸ—ï¸  Creating anticipated realm roles (expected from LDAP groups)...
ğŸ’¡ These roles are created in anticipation of LDAP groups that will map to them
   Future LDAP groups can be mapped to these pre-defined role names
   To add more anticipated roles, modify REALM_ROLES_TO_CREATE array above

   Creating anticipated role: admins (expected from LDAP group mapping)
   âœ… Created anticipated role: admins
   Creating anticipated role: developers (expected from LDAP group mapping)
   âœ… Created anticipated role: developers
ğŸ“ Note: Additional roles will be auto-created by LDAP mapper for groups not listed above

ğŸ‘‘ Assigning realm admin roles to 'admin-acme'...
âœ… Assigned realm admin roles
ğŸ§ª Testing realm admin login...
âœ… Realm admin login successful
ğŸ‰ Realm creation completed successfully!
ğŸ“‹ Configuration Summary:
   â€¢ Realm Name      : acme
   â€¢ Admin Username  : admin-acme
   â€¢ Admin Password  : admin-acme
   â€¢ Admin Email     : admin-acme@acme.local

ğŸŒ Access URLs:
   â€¢ Realm URL       : http://localhost:8090/realms/acme
   â€¢ Admin Console   : http://localhost:8090/admin/acme/console/
   â€¢ Account Console : http://localhost:8090/realms/acme/account/

ğŸ’¡ You can now use this realm for further configuration!
âœ… Realm 'acme' created successfully

ğŸ”„ Step 3: Adding LDAP provider...
ğŸ”§ Configuring Keycloak LDAP Provider for realm: acme
ğŸš€ Starting Keycloak LDAP configuration...
â³ Waiting for Keycloak and realm 'acme' to be ready...
âœ… Keycloak and realm 'acme' are ready!
ğŸ”‘ Getting admin token for 'admin-acme'...
âœ… Got admin token for realm 'acme'
ğŸ” Getting realm ID...
âœ… Got realm ID: 65172724-852a-479e-ad3f-833ba77cbe49
ğŸ” Checking if LDAP provider already exists...
ğŸ—ï¸  Creating  LDAP provider...
âœ… Created LDAP provider (ID: yBFiOY_rQ-iYBqzuAGILZQ)
ğŸ” Verifying LDAP provider was created...
âœ… LDAP provider verified:
   â€¢ ID: yBFiOY_rQ-iYBqzuAGILZQ
   â€¢ Name: ldap-provider-acme
   â€¢ Type: org.keycloak.storage.UserStorageProvider
   â€¢ Parent Realm ID: 65172724-852a-479e-ad3f-833ba77cbe49
âœ… Parent ID correctly set to realm UUID
ğŸ‰ Keycloak LDAP configuration completed successfully!
ğŸ” LDAP provider created with ID: yBFiOY_rQ-iYBqzuAGILZQ
ğŸ“‹ Configuration Summary:
   â€¢ Realm: acme
   â€¢ LDAP Provider     : ldap-provider-acme (ID: yBFiOY_rQ-iYBqzuAGILZQ)
   â€¢ LDAP Provider url : http://localhost:8090/admin/master/console/#/mirai/user-federation/ldap/yBFiOY_rQ-iYBqzuAGILZQ
   â€¢ LDAP Server       : ldap://ldap:389
   â€¢ Users DN       : ou=users,dc=min,dc=io
   â€¢ Groups DN      : ou=groups,dc=min,dc=io
   â€¢ Groups Filter  : Syncing all groups: admins, developers, ds1, ds2, ds3, user
   â€¢ Edit Mode      : READ_ONLY
   â€¢ Role Mapper    : Will be created by update_role_mapper.sh
   â€¢ Authentication : Realm Admin

ğŸŒ Access URLs:
   â€¢ Realm URL       : http://localhost:8090/realms/acme
   â€¢ Admin Console   : http://localhost:8090/admin/acme/console/
   â€¢ User Federation : http://localhost:8090/admin/acme/console/#/acme/user-federation

ğŸ”‘ Admin credentials:
   â€¢ Realm Admin: admin-acme/admin-acme

ğŸ’¡ The LDAP provider should now appear in:
   User Federation â†’ ldap-provider-acme
   If it doesn't appear immediately, try:
   1. Refreshing the page (Ctrl+F5)
   2. Clearing browser cache
   3. Logging out and back in to Keycloak

ğŸ”§ To debug further, run: ./debug_ldap_provider.sh acme

â¡ï¸  Next steps:
   1. Create role mapper: ./update_role_mapper.sh acme
   2. Sync users and roles: ./sync_ldap.sh acme
âœ… LDAP provider added successfully

 ğŸ”„ Step 4: Creating role mapper for LDAP groups...
ğŸ”§ Creating/Updating LDAP Role Mapper for realm: acme
ğŸš€ Starting LDAP role mapper configuration...
â³ Waiting for Keycloak and realm 'acme' to be ready...
âœ… Keycloak and realm 'acme' are ready!
ğŸ”‘ Getting admin token for 'admin-acme'...
âœ… Got admin token for realm 'acme'
ğŸ” Finding LDAP provider...
âœ… Found LDAP provider (ID: yBFiOY_rQ-iYBqzuAGILZQ)
ğŸ” Checking if role mapper already exists...
ğŸ—ï¸  Creating  LDAP role mapper...
âœ… Created role mapper (ID: b4f75d6b-c019-4082-8f9f-ace916fd3792)
ğŸ”„ Syncing roles from LDAP...
âŒ Role sync failed (HTTP 400)
{"errorMessage":"NameNotFound"}ğŸ” Verifying role mapper...
âœ… Role mapper verified:
   â€¢ ID: b4f75d6b-c019-4082-8f9f-ace916fd3792
   â€¢ Name: role-mapper-acme
   â€¢ Type: role-ldap-mapper
   â€¢ Roles DN: ou=groups,dc=min,dc=io
   â€¢ Roles Filter: (|(cn=admins)(cn=developers)(cn=ds1)(cn=ds2)(cn=ds3)(cn=user))
ğŸ“‹ Current realm roles in Keycloak:
   Î“Ã‡Ã³ default-roles-acme (ID: bcf16c78-21df-499d-8387-b40b1c7e5ee1)
   Î“Ã‡Ã³ uma_authorization (ID: e5137ee4-ed8d-44e4-9f41-d10ee856bb7a)
   Î“Ã‡Ã³ developers (ID: 81fa2f4e-3b90-4fe8-973d-abe59d420737)
   Î“Ã‡Ã³ offline_access (ID: bbd5ca90-d194-4f3c-9c52-e3ef83cdc00f)
   Î“Ã‡Ã³ admins (ID: 8b7ff29e-6429-41fa-bb81-0fe467deb8e3)
ğŸ‰ LDAP role mapper configuration completed successfully!
ğŸ“‹ Configuration Summary:
   â€¢ Realm: acme
   â€¢ LDAP Provider: ldap-provider-acme (ID: yBFiOY_rQ-iYBqzuAGILZQ)
   â€¢ Role Mapper: role-mapper-acme (ID: b4f75d6b-c019-4082-8f9f-ace916fd3792)
   â€¢ Roles DN: ou=groups,dc=min,dc=io
   â€¢ Pre-created Roles: admin, developer (created during realm setup)
   â€¢ Auto-created Roles: Will be created from LDAP group names during sync
   â€¢ LDAP Filter: Groups (admins, developers, ds1, ds2, ds3, user)
   â€¢ Mode: READ_ONLY
   â€¢ Mapping Type: Realm Roles (mix of pre-created and auto-created)

ğŸŒ Access URLs:
   â€¢ Role Mapper Config: http://localhost:8090/admin/acme/console/#/acme/user-federation/ldap/yBFiOY_rQ-iYBqzuAGILZQ/mappers/b4f75d6b-c019-4082-8f9f-ace916fd3792
   â€¢ Realm Roles: http://localhost:8090/admin/acme/console/#/acme/roles

ğŸ’¡ Role Mapping Strategy:
   â€¢ Pre-created roles (clean names):
     - LDAP Group 'admins' â†’ Realm Role 'admin' (pre-created)
     - LDAP Group 'developers' â†’ Realm Role 'developer' (pre-created)
   â€¢ Auto-created roles (LDAP group names):
     - LDAP Group 'ds1' â†’ Realm Role 'ds1' (auto-created)
     - LDAP Group 'ds2' â†’ Realm Role 'ds2' (auto-created)
     - LDAP Group 'ds3' â†’ Realm Role 'ds3' (auto-created)
     - LDAP Group 'user' â†’ Realm Role 'user' (auto-created)
   ğŸ“ To add more pre-created roles, modify REALM_ROLES_TO_CREATE in the script

ğŸ”§ To test role mappings:
   1. Log in with an LDAP user
   2. Check user's roles in the admin console
   3. Verify role assignments match LDAP group memberships

â¡ï¸  Next steps:
   â€¢ Test user login to verify role mappings
   â€¢ Configure application-specific role mappings if needed
   â€¢ Run user sync to ensure all role mappings are applied:
     ./sync_ldap.sh acme
âœ… Role mapper created successfully

ğŸ”„ Step 5: Syncing users and roles from LDAP...
ğŸ”„ Syncing LDAP Users and Roles for realm: acme
ğŸš€ Starting complete LDAP sync for realm: acme
ğŸ”‘ Getting admin token for 'admin-acme'...
âœ… Got admin token for realm 'acme'
ğŸ” Finding LDAP provider...
âœ… Found LDAP provider (ID: yBFiOY_rQ-iYBqzuAGILZQ)
ğŸ” Verifying role mapper configuration...
âœ… Role mapper found (ID: b4f75d6b-c019-4082-8f9f-ace916fd3792)
   â€¢ Roles DN: ou=groups,dc=min,dc=io
   â€¢ Roles Filter: (|(cn=admins)(cn=developers)(cn=ds1)(cn=ds2)(cn=ds3)(cn=user))
   â€¢ Mode: READ_ONLY
ğŸ”„ Syncing users from LDAP...
âŒ User sync failed (HTTP 400)
{"errorMessage":"NameNotFound"}ğŸ”„ Syncing roles from LDAP...
âŒ Role sync failed (HTTP 400)
{"errorMessage":"NameNotFound"}ğŸ“‹ Current realm roles in Keycloak:
   Î“Ã‡Ã³ default-roles-acme (ID: bcf16c78-21df-499d-8387-b40b1c7e5ee1)
   Î“Ã‡Ã³ uma_authorization (ID: e5137ee4-ed8d-44e4-9f41-d10ee856bb7a)
   Î“Ã‡Ã³ developers (ID: 81fa2f4e-3b90-4fe8-973d-abe59d420737)
   Î“Ã‡Ã³ offline_access (ID: bbd5ca90-d194-4f3c-9c52-e3ef83cdc00f)
   Î“Ã‡Ã³ admins (ID: 8b7ff29e-6429-41fa-bb81-0fe467deb8e3)
ğŸ‰ Complete LDAP sync completed!

ğŸ’¡ If users or roles are not appearing, try:
   1. Check the LDAP filter in the role mapper
   2. Verify LDAP connectivity
   3. Check LDAP group structure
   4. Refresh the Keycloak admin console
   5. Re-run this sync script
âœ… Users and roles synced successfully

ğŸ‰ Complete setup finished successfully!

ğŸ“‹ Setup Summary for realm 'acme':
   â€¢ All Docker services are running
   â€¢ LDAP server populated with users and groups
   â€¢ Keycloak realm 'acme' created
   â€¢ LDAP provider 'ldap-provider-acme' configured
   â€¢ Role mapper 'role-mapper-acme' configured
   â€¢ Users and roles synced from LDAP to Keycloak

ğŸŒ Access your setup:
   â€¢ Keycloak Admin     : http://localhost:8090/admin/acme/console/
   â€¢ Realm URL          : http://localhost:8090/realms/acme
   â€¢ LDAP Web Manager   : http://localhost:8091

ğŸ”‘ Admin credentials:
   â€¢ Keycloak Realm Admin: admin-acme / admin-acme
   â€¢ Keycloak Master Admin: admin / admin
   â€¢ LDAP Server (protocol): cn=admin,dc=min,dc=io / admin
   â€¢ LDAP Web Manager (web UI): admin / admin

ğŸ’¡ Expected roles created: admin, developer, ds_member, user
ğŸ’¡ Expected users synced: admin, alice, bob, charlie, willem, jp, louis, razvan, jack, andre, anwar

ğŸ”„ To sync again later, run: cd keycloak && ./sync_ldap.sh acme

ğŸ“– Usage examples:
   ./start_all.sh my-realm                    # Full automated setup
   ./start_all.sh my-realm --check-steps      # Interactive mode with confirmations
   ./start_all.sh --check-steps               # Interactive mode, will prompt for realm name

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¡ Optional: Load additional users and group assignments into LDAP
   This will import additional data from users.ldif and group_assign.ldif
   Run this if you want to add more test users beyond the basic setup
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Do you want to load additional users now? (y/N - default is No): y
ğŸ”„ Loading additional users into LDAP...
â³ Waiting for LDAP container to be fully ready...
âœ… LDAP container is ready and responding
âœ… LDAP containers are running
ğŸ“ Generating LDIF for additional users using containerized Python...
Known admin users: admin
Auto-detected mode: 'additional' (filename suggests additional users)
âš ï¸ğŸ—‘ï¸  Deleting old LDIF file: /opt/output/admins_only.ldif
âš ï¸ğŸ—‘ï¸  Deleting old LDIF file: /opt/output/users.ldif
âš ï¸ğŸ—‘ï¸  Deleting old LDIF file: /opt/output/group_assign.ldif
Using CSV file: data/users.csv
Output files: /opt/output/admins_only.ldif, /opt/output/users.ldif, /opt/output/group_assign.ldif
Admin users identified: admin
Admins processed: []
Users processed: ['alice', 'bob', 'charlie', 'willem', 'louis', 'jack', 'razvan', 'andre', 'jp', 'anwar']
LDIF files generated: /opt/output/admins_only.ldif, /opt/output/users.ldif, /opt/output/group_assign.ldif
ğŸ“‹ Additional users LDIF content preview:
========================================
dn: uid=alice,ou=users,dc=min,dc=io
objectClass: inetOrgPerson
cn: Alice Smith
sn: Smith
givenName: Alice
mail: alice@mycompany.local
uid: alice
userPassword: {SHA}8L0lGwgzjCMNQg8zEG+vE6EsrOU=

dn: uid=bob,ou=users,dc=min,dc=io
objectClass: inetOrgPerson
cn: Bob Johnson
sn: Johnson
givenName: Bob
mail: bob@mycompany.local
uid: bob
userPassword: {SHA}CkK2udzVafmQ3N5A9P9zxaJOuQQ=

dn: uid=charlie,ou=users,dc=min,dc=io
objectClass: inetOrgPerson
========================================
ğŸ“¥ Copying LDIF files to LDAP container...
Successfully copied 4.61kB to ldap:/tmp/users.ldif
Successfully copied 2.56kB to ldap:/tmp/group_assign.ldif
ğŸ”„ Adding new users and groups to LDAP...
Executing: docker exec ldap ldapadd -x -D cn=admin,dc=min,dc=io -w admin -f /tmp/users.ldif -c
C:/Users/wevenwel/AppData/Local/Temp/users.ldif: No such file or directory
âŒ LDAP command failed with exit code 1
ğŸ‘¥ Updating existing group memberships...
Executing: docker exec ldap ldapmodify -x -D cn=admin,dc=min,dc=io -w admin -f /tmp/group_assign.ldif -c
C:/Users/wevenwel/AppData/Local/Temp/group_assign.ldif: No such file or directory
âŒ LDAP command failed with exit code 1
ğŸ” Verifying import...
  Import verification:
   â€¢ Users in LDAP:  0
   â€¢ Groups in LDAP: 0
âš ï¸  Import may not have completed fully. Expected multiple users and groups.

ğŸŒ You can now access the updated LDAP:necho -e    LDAP Protocol:            ldap://localhost:389necho -e    LDAP Web Manager:         http://localhost:8080necho -e    LDAP Web Manager Login:   admin / admin

ğŸ“Š To verify the import, you can run:
   ldapsearch -x -H ldap://localhost:389 -D 'cn=admin,dc=min,dc=io' -w admin -b 'ou=users,dc=min,dc=io' '(objectClass=inetOrgPerson)'
ğŸ§¹ Cleanup...
ğŸ§¹ Cleanup completed

âœ… Additional users loaded. You may want to re-sync LDAP:
   cd keycloak && ./sync_ldap.sh acme